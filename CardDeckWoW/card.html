<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>WoW TCG: Vector Version</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #151515; /* –û—á–µ–Ω—å —Ç–µ–º–Ω—ã–π —Ñ–æ–Ω */
            font-family: 'Segoe UI', sans-serif;
            color: #ddd;
            touch-action: none; /* –ó–∞–ø—Ä–µ—Ç –∑—É–º–∞ –±—Ä–∞—É–∑–µ—Ä–∞ */
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* –ü—Ä–æ–ø—É—Å–∫–∞—Ç—å –∫–ª–∏–∫–∏ —Å–∫–≤–æ–∑—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫ –∫–∞–Ω–≤–∞—Å—É */
            z-index: 10;
        }

        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            pointer-events: auto; /* –ö–Ω–æ–ø–∫–∏ –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å */
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(to bottom, #4a4a4a, #2b2b2b);
            border: 1px solid #d4af37; /* –ó–æ–ª–æ—Ç–∞—è —Ä–∞–º–∫–∞ */
            color: #d4af37;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
            font-size: 14px;
        }
        .btn:active { transform: translateY(2px); }

        /* –ú–µ–Ω—é –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞–¥ –∫–∞—Ä—Ç–æ–π */
        #action-menu {
            position: absolute;
            display: none;
            gap: 15px;
            pointer-events: auto;
            transform: translate(-50%, -130%);
            z-index: 20;
        }

        .circle-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.8);
            font-family: sans-serif;
        }
        .tap { background: #d9534f; color: white; } /* –ö—Ä–∞—Å–Ω—ã–π */
        .flip { background: #5bc0de; color: white; } /* –°–∏–Ω–∏–π */

        #status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: #555;
            font-size: 12px;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="controls">
            <button class="btn" onclick="spawnVectorCard('Hero')">üëë –ì–µ—Ä–æ–π</button>
            <button class="btn" onclick="spawnVectorCard('Ally')">‚öîÔ∏è –û—Ä–∫ (–°–æ—é–∑–Ω–∏–∫)</button>
            <button class="btn" onclick="spawnVectorCard('Spell')">‚ú® –û–≥–Ω–µ–Ω–Ω—ã–π —à–∞—Ä</button>
            <button class="btn" onclick="spawnVectorCard('Quest')">üìú –ö–≤–µ—Å—Ç</button>
            <button class="btn" style="border-color: #777; color: #ccc;" onclick="resetCamera()">üëÅ –°–±—Ä–æ—Å</button>
        </div>

        <div id="action-menu">
            <div class="circle-btn tap" onclick="doTap()">‚Üª</div>
            <div class="circle-btn flip" onclick="doFlip()">üëÅ</div>
        </div>

        <div id="status">–í–µ—Ä—Å–∏—è –±–µ–∑ –∫–∞—Ä—Ç–∏–Ω–æ–∫ (–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞)</div>
    </div>

    <canvas id="c"></canvas>

    <script>
        // --- 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ---
        const canvas = new fabric.Canvas('c', {
            backgroundColor: '#151515',
            selection: false, // –û—Ç–∫–ª—é—á–∞–µ–º —Ä–∞–º–∫—É –≤—ã–¥–µ–ª–µ–Ω–∏—è –¥–ª—è —Ç–∞—á–∞
            preserveObjectStacking: true
        });

        function resize() {
            canvas.setWidth(window.innerWidth);
            canvas.setHeight(window.innerHeight);
            drawZones();
        }
        window.addEventListener('resize', resize);

        // --- 2. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–∞—Ä—Ç (–í–ï–ö–¢–û–†–ù–´–ô) ---
        // –†–∏—Å—É–µ—Ç –∫–∞—Ä—Ç—É –∫–æ–¥–æ–º, –Ω–µ –∑–∞–≥—Ä—É–∂–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∏
        
        function spawnVectorCard(type) {
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∏–¥–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            let color = '#333';
            let borderColor = '#fff';
            let title = 'Card';
            let icon = '';

            if (type === 'Hero') {
                color = '#2a1a1a'; // –¢–µ–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π
                borderColor = '#d4af37'; // –ó–æ–ª–æ—Ç–æ
                title = '–°–∏–ª—å–≤–∞–Ω–∞';
                icon = 'üëë';
            } else if (type === 'Ally') {
                color = '#1a2a1a'; // –¢–µ–º–Ω–æ-–∑–µ–ª–µ–Ω—ã–π
                borderColor = '#silver';
                title = '–ì—Ä—É–Ω—Ç –û—Ä–¥—ã';
                icon = '‚öîÔ∏è';
            } else if (type === 'Spell') {
                color = '#1a1a3a'; // –¢–µ–º–Ω–æ-—Å–∏–Ω–∏–π
                borderColor = '#a335ee'; // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π (–≠–ø–∏–∫)
                title = '–§–∞–π–µ—Ä–±–æ–ª';
                icon = '‚ú®';
            } else if (type === 'Quest') {
                color = '#3a3a2a'; // –ñ–µ–ª—Ç–æ–≤–∞—Ç—ã–π
                borderColor = '#d4af37';
                title = '–£–±–∏—Ç—å 10 –∫—Ä—ã—Å';
                icon = 'üìú';
            }

            // 1. –û—Å–Ω–æ–≤–∞ –∫–∞—Ä—Ç—ã (–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫)
            const rect = new fabric.Rect({
                width: 140,
                height: 200,
                fill: color,
                stroke: borderColor,
                strokeWidth: 4,
                rx: 10, ry: 10, // –ó–∞–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã
                originX: 'center', originY: 'center',
                shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.8)', blur: 15, offsetX: 5, offsetY: 5 })
            });

            // 2. –¢–µ–∫—Å—Ç –Ω–∞–∑–≤–∞–Ω–∏—è
            const textName = new fabric.Text(title, {
                fontSize: 16,
                fill: '#fff',
                fontFamily: 'Arial',
                fontWeight: 'bold',
                originX: 'center', originY: 'center',
                top: -60 // –°–¥–≤–∏–≥ –≤–≤–µ—Ä—Ö
            });

            // 3. –ò–∫–æ–Ω–∫–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É
            const textIcon = new fabric.Text(icon, {
                fontSize: 40,
                originX: 'center', originY: 'center',
                top: 10
            });

            // 4. –¢–µ–∫—Å—Ç —Ç–∏–ø–∞ (–≤–Ω–∏–∑—É)
            const textType = new fabric.Text(type.toUpperCase(), {
                fontSize: 12,
                fill: '#aaa',
                originX: 'center', originY: 'center',
                top: 70
            });

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –≤—Å—ë –≤ –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç
            const group = new fabric.Group([rect, textName, textIcon, textType], {
                left: canvas.width/2 - 50 + Math.random()*50,
                top: canvas.height/2 - 50 + Math.random()*50,
                // –°–≤–æ–∏ —Å–≤–æ–π—Å—Ç–≤–∞:
                _isTapped: false,
                _isFaceDown: false,
                _faceColor: color, // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Ü–≤–µ—Ç –ª–∏—Ü–∞
                _faceBorder: borderColor,
                _cardTitle: title
            });

            canvas.add(group);
            canvas.setActiveObject(group);
            updateMenu();
        }

        // --- 3. –õ–æ–≥–∏–∫–∞ –î–µ–π—Å—Ç–≤–∏–π ---

        const menu = document.getElementById('action-menu');

        function updateMenu() {
            const obj = canvas.getActiveObject();
            if (!obj) {
                menu.style.display = 'none';
                return;
            }

            // –°—Ç–∞–≤–∏–º –º–µ–Ω—é –Ω–∞–¥ –æ–±—ä–µ–∫—Ç–æ–º
            // object.oCoords.mt - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã "Middle Top" (—Å–µ—Ä–µ–¥–∏–Ω–∞ –≤–µ—Ä—Ö–∞)
            const coords = obj.getCoords(); // –ü–æ–ª—É—á–∞–µ–º —É–≥–ª—ã —Å —É—á–µ—Ç–æ–º –ø–æ–≤–æ—Ä–æ—Ç–∞
            // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –±–µ—Ä–µ–º —Ü–µ–Ω—Ç—Ä bounding box
            const bound = obj.getBoundingRect();
            
            menu.style.display = 'flex';
            menu.style.left = (bound.left + bound.width / 2) + 'px';
            menu.style.top = bound.top + 'px';
        }

        // –ü—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –∫–∞—Ä—Ç—ã —Å–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é, –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
        canvas.on('object:moving', () => menu.style.display = 'none');
        canvas.on('object:scaling', () => menu.style.display = 'none');
        canvas.on('object:rotating', () => menu.style.display = 'none');
        canvas.on('object:modified', updateMenu);
        canvas.on('selection:created', updateMenu);
        canvas.on('selection:updated', updateMenu);
        canvas.on('selection:cleared', () => menu.style.display = 'none');

        // –ö–Ω–æ–ø–∫–∞: –ü–ï–†–ï–í–ï–†–ù–£–¢–¨ (–†–µ—Å—É—Ä—Å)
        window.doFlip = function() {
            const obj = canvas.getActiveObject();
            if (!obj || obj.type !== 'group') return;

            obj._isFaceDown = !obj._isFaceDown;
            const rect = obj.item(0); // –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ (–æ—Å–Ω–æ–≤–∞)
            const texts = [obj.item(1), obj.item(2), obj.item(3)]; // –¢–µ–∫—Å—Ç—ã

            if (obj._isFaceDown) {
                // –†—É–±–∞—à–∫–∞ (Resource)
                rect.set('fill', '#081a38'); // –°–∏–Ω–∏–π —Ü–≤–µ—Ç —Ä—É–±–∞—à–∫–∏ WoW
                rect.set('stroke', '#444');
                // –°–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç
                texts.forEach(t => t.set('opacity', 0));
            } else {
                // –õ–∏—Ü–æ
                rect.set('fill', obj._faceColor);
                rect.set('stroke', obj._faceBorder);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç
                texts.forEach(t => t.set('opacity', 1));
            }
            
            canvas.requestRenderAll();
        };

        // –ö–Ω–æ–ø–∫–∞: –ü–û–í–ï–†–ù–£–¢–¨ (Tap)
        window.doTap = function() {
            const obj = canvas.getActiveObject();
            if (!obj) return;

            obj._isTapped = !obj._isTapped;
            const angle = obj._isTapped ? 90 : 0;
            
            obj.animate('angle', angle, {
                onChange: canvas.renderAll.bind(canvas),
                onComplete: updateMenu, // –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –º–µ–Ω—é, —Ç.–∫. —Ä–∞–º–∫–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
                duration: 200,
                easing: fabric.util.ease.easeOutQuad
            });
        };
        
        // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ = Flip
        canvas.on('mouse:dblclick', () => window.doFlip());

        // --- 4. –ó—É–º –∏ –ü–∞–Ω (–ú—É–ª—å—Ç–∏—Ç–∞—á + –ö–æ–ª–µ—Å–æ) ---
        
        canvas.on('mouse:wheel', function(opt) {
            var delta = opt.e.deltaY;
            var zoom = canvas.getZoom();
            zoom *= 0.999 ** delta;
            if (zoom > 5) zoom = 5;
            if (zoom < 0.2) zoom = 0.2;
            canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, zoom);
            opt.e.preventDefault();
            opt.e.stopPropagation();
            menu.style.display = 'none';
        });

        // –ü—Ä–æ—Å—Ç–æ–π —Ç–∞—á-–∑—É–º (Pinch) - —á–µ—Ä–µ–∑ –Ω–∞—Ç–∏–≤–Ω—ã–π JS, —Ç–∞–∫ –∫–∞–∫ Fabric –∏–Ω–æ–≥–¥–∞ –≥–ª—é—á–∏—Ç
        let initialDistance = 0;
        let initialZoom = 1;
        
        canvas.upperCanvasEl.addEventListener('touchstart', function(e) {
            if (e.touches.length === 2) {
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                initialDistance = Math.sqrt(dx*dx + dy*dy);
                initialZoom = canvas.getZoom();
                e.preventDefault();
            }
        }, { passive: false });

        canvas.upperCanvasEl.addEventListener('touchmove', function(e) {
            if (e.touches.length === 2 && initialDistance > 0) {
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                const currentDistance = Math.sqrt(dx*dx + dy*dy);
                
                let zoom = initialZoom * (currentDistance / initialDistance);
                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
                if(zoom > 5) zoom = 5; 
                if(zoom < 0.3) zoom = 0.3;

                // –ó—É–º –≤ —Ü–µ–Ω—Ç—Ä —ç–∫—Ä–∞–Ω–∞ (–ø—Ä–æ—â–µ –¥–ª—è —Ç–∞—á–∞)
                const center = canvas.getVpCenter();
                canvas.zoomToPoint({ x: center.x, y: center.y }, zoom);
                
                menu.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –∑—É–º–µ
                e.preventDefault();
            }
        }, { passive: false });

        window.resetCamera = function() {
            canvas.setViewportTransform([1,0,0,1,0,0]);
        }

        // --- 5. –ó–æ–Ω—ã ---
        function drawZones() {
            canvas.getObjects().forEach(o => {
                if (o.isZone) canvas.remove(o);
            });

            const y = window.innerHeight - 220;
            const line = new fabric.Line([0, y, window.innerWidth, y], {
                stroke: '#333', strokeWidth: 2, strokeDashArray: [10, 10],
                selectable: false, evented: false, isZone: true
            });
            const text = new fabric.Text('–†–ï–°–£–†–°–´ (–ö–ª–∞–¥–∏ —Å—é–¥–∞)', {
                left: 20, top: y + 10, fontSize: 16, fill: '#555',
                selectable: false, evented: false, isZone: true
            });
            
            canvas.add(line); canvas.add(text);
            canvas.sendToBack(line); canvas.sendToBack(text);
        }

        // –°—Ç–∞—Ä—Ç
        resize();
        drawZones();
        // –°–ø–∞–≤–Ω–∏–º 2 —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã
        spawnVectorCard('Hero');
        setTimeout(() => spawnVectorCard('Ally'), 200);

    </script>
</body>
</html>
