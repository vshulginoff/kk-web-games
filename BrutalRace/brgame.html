<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rally Legends: Top Down</title>
    <script src="https://yandex.ru/games/sdk/v2"></script>
    <style>
        /* COLIN MCRAE STYLE UI */
        @import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700;900&display=swap');

        :root { --rally-blue: #0055aa; --rally-yellow: #ffcc00; --bg: #3e3832; }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0; overflow: hidden; background: #111;
            font-family: 'Exo 2', sans-serif; color: white;
            user-select: none; touch-action: none; position: fixed; width: 100%; height: 100%;
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* UI OVERLAY */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
        }

        /* MENU SCREEN */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 85, 170, 0.95); /* Rally Blue */
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100; transition: opacity 0.3s; pointer-events: auto;
        }
        .hidden { opacity: 0; pointer-events: none; z-index: -1; }

        h1 { 
            font-size: 48px; font-weight: 900; font-style: italic; 
            text-transform: uppercase; letter-spacing: 2px; margin: 0;
            border-bottom: 4px solid var(--rally-yellow); padding-bottom: 10px;
        }
        p { font-size: 18px; color: #ddd; margin-bottom: 40px; }

        .btn {
            background: transparent; border: 2px solid white; color: white;
            padding: 15px 60px; font-size: 24px; font-weight: 700; text-transform: uppercase;
            cursor: pointer; transition: all 0.2s; font-family: 'Exo 2', sans-serif;
        }
        .btn:active { background: white; color: var(--rally-blue); transform: scale(0.95); }

        /* HUD */
        #hud-top { 
            padding: 20px; display: flex; justify-content: space-between; 
            font-weight: 900; font-size: 24px; text-shadow: 2px 2px 0 #000;
        }
        .timer-box { color: var(--rally-yellow); font-family: monospace; font-size: 32px; }
        .gear-indicator { 
            width: 50px; height: 50px; border: 2px solid white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 28px;
        }

        /* CONTROLS */
        .controls { 
            display: flex; justify-content: space-between; padding: 20px; 
            pointer-events: none; margin-bottom: 20px;
        }
        .c-group { display: flex; gap: 20px; pointer-events: auto; align-items: flex-end; }
        .c-btn {
            width: 80px; height: 80px; background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.5); border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; color: white; backdrop-filter: blur(5px);
        }
        .c-btn:active { background: rgba(255,255,255,0.3); border-color: var(--rally-yellow); }
    </style>
</head>
<body>

<div id="start-screen" class="screen">
    <h1>RALLY LEGENDS</h1>
    <p>STAGE 1: FOREST GRAVEL</p>
    <button class="btn" onclick="startGame()">START STAGE</button>
</div>

<div id="gameover-screen" class="screen hidden">
    <h1 id="go-title">STAGE FINISH</h1>
    <p>TIME: <span id="final-time">00:00.00</span></p>
    <button class="btn" onclick="startGame()">RESTART</button>
</div>

<div class="ui-layer">
    <div id="hud-top">
        <div id="gear" class="gear-indicator">N</div>
        <div id="timer" class="timer-box">00:00.00</div>
    </div>

    <div class="controls">
        <div class="c-group">
            <div id="b-left" class="c-btn">◄</div>
            <div id="b-right" class="c-btn">►</div>
        </div>
        <div class="c-group">
            <div id="b-brake" class="c-btn" style="border-color:#ff4444">B</div>
            <div id="b-gas" class="c-btn" style="border-color:#44ff44">A</div>
        </div>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    // --- 1. RALLY PHYSICS CONFIG ---
    const PHYS = {
        maxSpeed: 22,        // Достаточно быстро для ралли
        accel: 0.18,         // Мощный разгон (полный привод)
        friction: 0.98,      // Гравий (машина катится)
        turnSpeed: 0.055,    // Острый руль
        grip: 0.91,          // Скользко! (0.9 - лед, 1.0 - асфальт)
        driftDecay: 0.94     // Как быстро гасится боковое скольжение
    };

    // --- 2. ENGINE SETUP ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d', { alpha: false });
    
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    let gameState = 'MENU';
    let keys = {};
    let player;
    let particles = [];
    let trees = [];
    let startTime = 0;
    let finishTime = 0;
    
    // Камера
    const cam = { x: 0, y: 0, zoom: 0.8 };

    // Трасса (Спецучасток - незамкнутый, длинный)
    // Генерируем извилистую дорогу
    const trackWidth = 500;
    const trackPoints = [];
    
    function generateTrack() {
        trackPoints.length = 0;
        let x = 0, y = 0;
        let angle = -Math.PI / 2; // Вверх
        
        // Старт
        for(let i=0; i<5; i++) { y-=400; trackPoints.push({x, y}); }
        
        // Процедурная генерация поворотов
        for(let i=0; i<40; i++) {
            // Случайный поворот
            let curve = (Math.random() - 0.5) * 1.5; 
            let length = 600 + Math.random() * 600;
            
            // Разбиваем поворот на сегменты для плавности
            let segments = 5;
            for(let j=0; j<segments; j++) {
                angle += curve / segments;
                x += Math.cos(angle) * (length/segments);
                y += Math.sin(angle) * (length/segments);
                trackPoints.push({x, y});
            }
        }
        
        // Генерируем лес вокруг трассы
        trees = [];
        for(let i=0; i<trackPoints.length-1; i++) {
            let p1 = trackPoints[i];
            let p2 = trackPoints[i+1];
            let dist = Math.hypot(p1.x-p2.x, p1.y-p2.y);
            let steps = Math.floor(dist / 100);
            
            for(let s=0; s<steps; s++) {
                let t = s/steps;
                let cx = p1.x + (p2.x-p1.x)*t;
                let cy = p1.y + (p2.y-p1.y)*t;
                
                // Слева и справа
                if(Math.random()>0.3) trees.push({ x: cx - trackWidth/2 - 100 - Math.random()*300, y: cy + (Math.random()-0.5)*100, r: 40+Math.random()*30 });
                if(Math.random()>0.3) trees.push({ x: cx + trackWidth/2 + 100 + Math.random()*300, y: cy + (Math.random()-0.5)*100, r: 40+Math.random()*30 });
            }
        }
    }

    // --- 3. CAR CLASS (RALLY SPEC) ---
    class RallyCar {
        constructor() {
            this.x = trackPoints[0].x;
            this.y = trackPoints[0].y + 200;
            this.angle = -Math.PI / 2;
            this.speed = 0;
            
            // Векторы движения (для дрифта)
            this.vx = 0;
            this.vy = 0;
            
            this.w = 34;
            this.l = 66;
            this.finished = false;
        }

        update() {
            if(this.finished) {
                this.speed *= 0.95;
                this.x += this.vx; this.y += this.vy;
                return;
            }

            // Controls
            if(keys.up) this.speed += PHYS.accel;
            else if(keys.down) this.speed -= PHYS.accel * 1.5; // Тормоз
            else this.speed *= PHYS.friction; // Инерция

            if(this.speed > PHYS.maxSpeed) this.speed = PHYS.maxSpeed;
            if(this.speed < -6) this.speed = -6;

            // Steering
            if(Math.abs(this.speed) > 0.5) {
                let dir = this.speed > 0 ? 1 : -1;
                // На высокой скорости руль "тяжелеет" (меньше угол)
                let speedFactor = 1 - (Math.abs(this.speed) / PHYS.maxSpeed) * 0.3;
                
                if(keys.left) this.angle -= PHYS.turnSpeed * dir * speedFactor;
                if(keys.right) this.angle += PHYS.turnSpeed * dir * speedFactor;
            }

            // PHYSICS: Drift Math
            // 1. Куда смотрят колеса
            let frontX = Math.cos(this.angle) * this.speed;
            let frontY = Math.sin(this.angle) * this.speed;

            // 2. Куда мы летим по инерции (предыдущий вектор)
            // Плавный переход от инерции к вектору колес
            this.vx = this.vx * PHYS.driftDecay + frontX * (1 - PHYS.driftDecay);
            this.vy = this.vy * PHYS.driftDecay + frontY * (1 - PHYS.driftDecay);

            // 3. Добавляем Grip (сцепление)
            // Чем выше скорость и резче поворот, тем меньше сцепление
            // Но мы упростим: просто смешиваем вектора
            let finalX = frontX * PHYS.grip + this.vx * (1 - PHYS.grip);
            let finalY = frontY * PHYS.grip + this.vy * (1 - PHYS.grip);
            
            // Обновляем позицию
            this.x += finalX;
            this.y += finalY;
            
            // Обновляем "инерционный вектор" для следующего кадра (хитрость для дрифта)
            this.vx = finalX;
            this.vy = finalY;

            // DUST PARTICLES
            // Если дрифтуем (разница между углом корпуса и вектором движения)
            let moveAngle = Math.atan2(this.vy, this.vx);
            let driftAngle = Math.abs(this.angle - moveAngle);
            if(driftAngle > 3.14) driftAngle -= 3.14; // Коррекция круга

            if((Math.abs(this.speed) > 8 && driftAngle > 0.2) || (keys.up && Math.abs(this.speed) < 10)) {
                // Пыль из-под колес
                for(let i=0; i<2; i++) {
                    particles.push({
                        x: this.x - Math.cos(this.angle)*25 + (Math.random()-0.5)*20,
                        y: this.y - Math.sin(this.angle)*25 + (Math.random()-0.5)*20,
                        vx: (Math.random()-0.5)*2,
                        vy: (Math.random()-0.5)*2,
                        life: 40 + Math.random()*20,
                        size: 5 + Math.random()*10,
                        c: `rgba(180, 160, 140, ${0.3 + Math.random()*0.3})` // Цвет пыли
                    });
                }
            }

            // COLLISION (Trees)
            for(let t of trees) {
                if((this.x-t.x)**2 + (this.y-t.y)**2 < (t.r + 15)**2) {
                    // Удар о дерево
                    this.speed *= -0.5;
                    this.vx *= -0.5; this.vy *= -0.5;
                    this.x += (this.x - t.x) * 0.1; // Отскок
                    this.y += (this.y - t.y) * 0.1;
                    AudioEngine.rev(0); // Звук сброса
                }
            }

            // Check Finish
            let endP = trackPoints[trackPoints.length-1];
            if(Math.hypot(this.x-endP.x, this.y-endP.y) < 300 && !this.finished) {
                this.finished = true;
                finishGame();
            }

            AudioEngine.rev(Math.abs(this.speed));
        }

        draw(ctx) {
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.angle);

            // Классическая синяя раллийная машина (Subaru style)
            
            // Тень
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.fillRect(-18, -18, 36, 36);

            // Колеса (поворачиваются?)
            ctx.fillStyle = '#222';
            ctx.fillRect(-18, -20, 10, 12); ctx.fillRect(-18, 8, 10, 12);
            ctx.fillRect(8, -20, 10, 12); ctx.fillRect(8, 8, 10, 12);

            // Корпус (Синий)
            ctx.fillStyle = '#0055aa';
            // Используем path для аэродинамики
            ctx.beginPath();
            ctx.moveTo(18, -15); ctx.lineTo(18, 15); // Перед
            ctx.lineTo(-18, 15); ctx.lineTo(-18, -15); // Зад
            ctx.fill();

            // Желтые наклейки (Ралли ливрея)
            ctx.fillStyle = '#ffcc00';
            ctx.fillRect(-5, -15, 10, 30); // Полоса сбоку (в данном случае сверху)
            // Логотип на капоте
            ctx.beginPath(); ctx.arc(8, 0, 6, 0, Math.PI*2); ctx.fill();

            // Стекла
            ctx.fillStyle = '#111';
            ctx.fillRect(-8, -10, 8, 20); // Лобовое
            ctx.fillRect(-16, -8, 4, 16); // Заднее

            // Спойлер
            ctx.fillStyle = '#0055aa';
            ctx.fillRect(-22, -16, 6, 32);

            // Фары
            ctx.fillStyle = '#fff';
            ctx.fillRect(16, -14, 4, 6); ctx.fillRect(16, 8, 4, 6);
            
            // Стопы
            if(keys.down) {
                ctx.fillStyle = '#f00'; ctx.shadowBlur=10; ctx.shadowColor='red';
                ctx.fillRect(-18, -12, 2, 6); ctx.fillRect(-18, 6, 2, 6);
                ctx.shadowBlur=0;
            }

            ctx.restore();
        }
    }

    // --- 4. AUDIO ENGINE (SYNTH) ---
    const AudioEngine = {
        ctx: null, osc: null, gain: null,
        init: function() {
            try {
                const AC = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AC();
                this.master = this.ctx.createGain(); this.master.gain.value = 0.15;
                this.master.connect(this.ctx.destination);
                
                this.osc = this.ctx.createOscillator();
                this.osc.type = 'sawtooth'; // Агрессивный звук мотора
                this.osc.frequency.value = 100;
                
                this.gain = this.ctx.createGain();
                this.gain.gain.value = 0;
                
                this.osc.connect(this.gain);
                this.gain.connect(this.master);
                this.osc.start();
            } catch(e) {}
        },
        rev: function(speed) {
            if(!this.ctx) return;
            // Питч зависит от скорости (обороты)
            let freq = 80 + (speed * 15);
            this.osc.frequency.setTargetAtTime(freq, this.ctx.currentTime, 0.1);
            
            // Громкость: если стоим - тихо урчит, едем - громко
            let vol = (speed > 0.1) ? 0.3 : 0.1;
            this.gain.gain.setTargetAtTime(vol, this.ctx.currentTime, 0.1);
        }
    };

    // --- 5. MAIN LOOP ---
    function update() {
        if(gameState !== 'GAME') return;

        player.update();

        // Particles
        for(let i=particles.length-1; i>=0; i--) {
            let p = particles[i];
            p.x += p.vx; p.y += p.vy;
            p.life--;
            p.size *= 1.02; // Пыль растет
            if(p.life <= 0) particles.splice(i,1);
        }

        // Camera Logic
        cam.x += (player.x - cam.x) * 0.1;
        cam.y += (player.y - cam.y) * 0.1;

        // UI Updates
        let time = (Date.now() - startTime) / 1000;
        document.getElementById('timer').innerText = time.toFixed(2);
        
        let gear = 'N';
        if(player.speed > 1) gear = Math.ceil(player.speed / 5);
        if(player.speed < -1) gear = 'R';
        document.getElementById('gear').innerText = gear;
    }

    function draw() {
        if(gameState === 'MENU') { ctx.fillStyle='#0055aa'; ctx.fillRect(0,0,canvas.width,canvas.height); return; }

        // Background (Dirt)
        ctx.fillStyle = '#5d4037'; // Темная земля
        ctx.fillRect(0,0,canvas.width,canvas.height);

        ctx.save();
        ctx.translate(canvas.width/2, canvas.height/2);
        ctx.scale(cam.zoom, cam.zoom);
        ctx.translate(-cam.x, -cam.y);

        // Draw Track (Gravel)
        ctx.lineCap = 'round'; ctx.lineJoin = 'round';
        ctx.lineWidth = trackWidth + 40; 
        ctx.strokeStyle = 'rgba(0,0,0,0.3)'; // Тень трассы
        ctx.beginPath(); drawTrackPath(ctx); ctx.stroke();

        ctx.lineWidth = trackWidth;
        ctx.strokeStyle = '#8d6e63'; // Гравий (светлее фона)
        ctx.stroke();
        
        // Следы шин (можно оптимизировать, но пока просто рисуем поверх асфальта)
        // В реальной игре лучше использовать canvas для следов, но тут упростим

        // Trees
        trees.forEach(t => {
            // Simple Tree
            ctx.fillStyle = 'rgba(0,0,0,0.4)'; ctx.beginPath(); ctx.arc(t.x+10, t.y+10, t.r, 0, Math.PI*2); ctx.fill(); // Shadow
            ctx.fillStyle = '#2e7d32'; ctx.beginPath(); ctx.arc(t.x, t.y, t.r, 0, Math.PI*2); ctx.fill(); // Leaves
            ctx.fillStyle = '#1b5e20'; ctx.beginPath(); ctx.arc(t.x, t.y, t.r*0.7, 0, Math.PI*2); ctx.fill(); // Detail
        });

        // Finish Line
        let endP = trackPoints[trackPoints.length-1];
        let prevP = trackPoints[trackPoints.length-2];
        let angle = Math.atan2(endP.y-prevP.y, endP.x-prevP.x);
        ctx.save();
        ctx.translate(endP.x, endP.y);
        ctx.rotate(angle);
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, -trackWidth/2, 20, trackWidth); // Line
        // Checkered flag pattern
        for(let i=0; i<10; i++) {
            ctx.fillStyle = (i%2==0)?'#000':'#fff';
            ctx.fillRect(0, -trackWidth/2 + i*(trackWidth/10), 20, trackWidth/10);
        }
        ctx.restore();

        // Particles (Dust is under the car usually, but we draw simple order)
        particles.forEach(p => {
            ctx.fillStyle = p.c;
            ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
        });

        // Player
        player.draw(ctx);

        ctx.restore();
    }

    function drawTrackPath(c) {
        c.moveTo(trackPoints[0].x, trackPoints[0].y);
        for(let i=1; i<trackPoints.length; i++) c.lineTo(trackPoints[i].x, trackPoints[i].y);
    }

    function loop() {
        requestAnimationFrame(loop);
        update();
        draw();
    }

    function startGame() {
        AudioEngine.init();
        if(AudioEngine.ctx && AudioEngine.ctx.state==='suspended') AudioEngine.ctx.resume();

        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('gameover-screen').classList.add('hidden');
        
        generateTrack();
        player = new RallyCar();
        cam.x = player.x; cam.y = player.y;
        particles = [];
        startTime = Date.now();
        gameState = 'GAME';
    }

    function finishGame() {
        let time = (Date.now() - startTime) / 1000;
        document.getElementById('final-time').innerText = time.toFixed(2);
        document.getElementById('gameover-screen').classList.remove('hidden');
    }

    // --- CONTROLS ---
    function bindBtn(id, k) {
        const b = document.getElementById(id);
        const s = (v) => { keys[k] = v; v?b.style.opacity=0.5:b.style.opacity=1; };
        b.addEventListener('touchstart', e=>{e.preventDefault(); s(true)},{passive:false});
        b.addEventListener('touchend', e=>{e.preventDefault(); s(false)},{passive:false});
        b.addEventListener('mousedown', ()=>s(true)); 
        b.addEventListener('mouseup', ()=>s(false));
    }
    bindBtn('b-gas','up'); bindBtn('b-brake','down');
    bindBtn('b-left','left'); bindBtn('b-right','right');

    window.onkeydown=e=>{
        if(e.code=='ArrowUp')keys.up=true;
        if(e.code=='ArrowDown')keys.down=true;
        if(e.code=='ArrowLeft')keys.left=true;if(e.code=='ArrowRight')keys.right=true;
    };
    window.onkeyup=e=>{
        if(e.code=='ArrowUp')keys.up=false;
        if(e.code=='ArrowDown')keys.down=false;
        if(e.code=='ArrowLeft')keys.left=false;if(e.code=='ArrowRight')keys.right=false;
    };

    loop();
</script>
</body>
</html>
