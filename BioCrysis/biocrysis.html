<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BIO-SLAYER: DEV EDITION</title>
    
    <script src="https://yandex.ru/games/sdk/v2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- –°–¢–ò–õ–ò –ö–û–†–ü–£–°–ê --- */
        html, body { 
            width: 100%; height: 100%; margin: 0; padding: 0; 
            overflow: hidden; background: #e3dac9; 
            font-family: 'Press Start 2P', monospace; color: #222;
            touch-action: none; user-select: none; -webkit-user-select: none;
            display: flex; flex-direction: column; align-items: center;
        }

        #screen-bezel {
            width: 100%; max-width: 600px; aspect-ratio: 4/3;
            background: #000;
            border: 15px solid #d0c0b0; border-bottom-width: 30px;
            border-radius: 10px 10px 30px 10px;
            position: relative;
            box-shadow: inset 0 0 10px #000, 0 5px 15px rgba(0,0,0,0.3);
            margin-top: 10px; overflow: hidden;
        }

        #game-container { width: 100%; height: 100%; background: #110000; }
        
        #damage-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: red; opacity: 0; pointer-events: none; z-index: 20; transition: opacity 0.1s;
        }
        #pixel-grid {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(0,0,0,0) 50%, rgba(0,0,0,0.2) 50%), 
                        linear-gradient(90deg, rgba(255,255,255,0.03), rgba(0,0,0,0.03));
            background-size: 100% 4px, 4px 100%; pointer-events: none; z-index: 5;
        }
        #floating-text-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 25;
        }

        /* HUD */
        .hud-overlay {
            position: absolute; top: 5px; left: 8px; right: 8px;
            display: flex; justify-content: space-between;
            font-size: 10px; color: #fff; text-shadow: 1px 1px 0 #000;
            z-index: 10; pointer-events: none; font-weight: bold;
        }
        #hud-dna { color: #f0f; }
        #key-icon { display: none; color: #ff0; text-shadow: 0 0 5px #f00; animation: pulse 1s infinite; }

        /* –õ–û–ì –ò –î–ò–ê–õ–û–ì–ò */
        #log-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 35%;
            background: rgba(0, 0, 30, 0.95); border-top: 2px solid #fff;
            display: flex; flex-direction: column; padding: 8px; box-sizing: border-box; z-index: 15;
        }
        #log-text { font-size: 9px; color: #ccc; margin-bottom: 5px; line-height: 1.5; flex-grow: 1; white-space: pre-wrap; overflow: hidden; }
        .d-opts { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; display: none; }
        .d-btn { background: #fff; color: #000; border: 2px solid #555; padding: 6px; font-family: inherit; font-size: 8px; cursor: pointer; text-transform: uppercase; text-align: center; }
        .d-btn:active { background: #ff0; }

        /* –≠–ö–†–ê–ù–´ */
        .screen-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: #000; z-index: 100;
            display: none; flex-direction: column; 
            padding: 20px; box-sizing: border-box;
            color: #fff; text-align: center; align-items: center; justify-content: center;
        }
        .intro-title { color: #f00; font-size: 18px; margin-bottom: 10px; text-shadow: 2px 2px 0 #fff; }
        .intro-text { font-size: 10px; line-height: 1.6; color: #aaa; max-width: 90%; text-align: left; border: 1px solid #444; padding: 10px; margin-bottom: 20px;}
        .blink-btn { 
            color: #000; background: #0f0; padding: 12px 20px; text-align: center; 
            cursor: pointer; animation: blink 1s infinite; font-weight: bold; margin-top: auto; border: 2px solid #fff;
        }
        @keyframes blink { 50% { opacity:0.5; } }
        
        .float-msg {
            position: absolute; font-size: 12px; font-weight: bold; 
            animation: floatUp 1s forwards; text-shadow: 1px 1px 0 #000;
        }
        @keyframes floatUp { 0% { transform: translateY(0); opacity:1; } 100% { transform: translateY(-50px); opacity:0; } }

        /* –£–ü–†–ê–í–õ–ï–ù–ò–ï */
        #controls-area { flex-grow: 1; width: 100%; max-width: 600px; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative;}
        
        .dpad-container {
            display: grid; grid-template-columns: 45px 45px 45px; grid-template-rows: 30px 45px 45px 45px;
            gap: 4px; margin-bottom: 10px; align-items: center; justify-items: center;
        }
        .btn { background: #333; border-radius: 4px; cursor: pointer; box-shadow: 0 4px 0 #111; display: flex; align-items: center; justify-content: center; font-size: 18px; color: #888; width: 100%; height: 100%; }
        .btn:active { transform: translateY(4px); box-shadow: none; background: #555; color: #fff; }
        .btn-strafe { background: #555; color: #fff; font-size: 10px; height: 30px; margin-bottom: 5px; font-weight: bold;}
        
        .action-btns { position: absolute; right: 20px; bottom: 35%; display: flex; gap: 15px; transform: rotate(-10deg); }
        .round-btn { width: 55px; height: 55px; border-radius: 50%; background: #cc0000; box-shadow: 0 5px 0 #660000; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; font-weight: bold; color: #fff; }
        .round-btn:active { transform: translateY(5px); box-shadow: none; background: #ff3333; }
        #btn-act.talk-mode { background: #0000cc; box-shadow: 0 5px 0 #000066; }
        
        #minimap { position: absolute; top: 25px; right: 5px; width: 50px; height: 50px; background: rgba(255,255,255,0.9); border: 2px solid #000; z-index: 8; image-rendering: pixelated; }
        .brand { position: absolute; bottom: 10px; right: 20px; font-size: 10px; color: #888; font-style: italic; }
        
        #error-msg { position:absolute; top:0; left:0; width:100%; background:red; color:white; font-size:10px; display:none; z-index:999; padding:5px; }

        /* --- DEV EDITOR STYLES --- */
        #dev-btn {
            position: absolute; top: 5px; left: 5px; width: 30px; height: 30px;
            background: rgba(0,0,0,0.5); color: #0f0; border: 1px solid #0f0;
            font-size: 8px; cursor: pointer; z-index: 200; display: flex; align-items: center; justify-content: center;
        }
        #editor-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 300; display: none;
            flex-direction: column; font-family: 'Roboto Mono', monospace; color: #fff;
            overflow: hidden;
        }
        .editor-header {
            padding: 10px; background: #222; border-bottom: 1px solid #444;
            display: flex; justify-content: space-between; align-items: center;
        }
        .editor-tabs { display: flex; gap: 5px; padding: 5px; background: #151515; }
        .tab-btn { padding: 5px 10px; background: #333; cursor: pointer; border: none; color: #aaa; font-size: 10px; }
        .tab-btn.active { background: #555; color: #fff; }
        .editor-content { flex-grow: 1; overflow-y: auto; padding: 10px; }
        
        .edit-group { margin-bottom: 15px; border: 1px solid #333; padding: 10px; background: #1a1a1a; }
        .edit-group h4 { margin: 0 0 10px 0; color: #0f0; font-size: 12px; }
        .form-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .form-row label { width: 60px; font-size: 10px; color: #888; }
        input, textarea { background: #222; border: 1px solid #444; color: #fff; width: 100%; font-family: inherit; font-size: 11px; padding: 3px; }
        textarea { height: 60px; resize: vertical; }
        
        .save-bar { padding: 10px; background: #222; border-top: 1px solid #444; display: flex; gap: 10px; }
        .action-btn { flex: 1; padding: 10px; cursor: pointer; text-align: center; font-weight: bold; font-size: 10px; border: none; }
        .btn-save { background: #006600; color: #fff; }
        .btn-reset { background: #660000; color: #fff; }
        .btn-export { background: #004488; color: #fff; }
    </style>
</head>
<body>

<div id="error-msg"></div>

<div id="screen-bezel">
    <div id="dev-btn">DEV</div> <div id="game-container"></div>
    <div id="damage-overlay"></div>
    <div id="pixel-grid"></div>
    <div id="floating-text-container"></div>
    
    <div class="hud-overlay">
        <span>HP <span id="ui-hp">100</span></span>
        <span id="key-icon">üîë</span>
        <span id="hud-dna" style="color:#f0f">üß¨ <span id="ui-dna">0</span></span>
        <span>AMMO <span id="ui-ammo">10</span></span>
    </div>
    
    <canvas id="minimap" width="50" height="50"></canvas>

    <div id="log-overlay">
        <div id="log-text"></div>
        <div class="d-opts" id="d-opts"></div>
    </div>
    
    <div id="main-menu" class="screen-overlay" style="display:flex;">
        <h1 style="color:#f0f; font-size:24px; text-shadow:2px 2px #fff;">BIO-SLAYER<br><span style="font-size:12px; color:#fff">CELL TACTICS</span></h1>
        <div class="blink-btn" id="start-btn">–ò–ì–†–ê–¢–¨</div>
    </div>

    <div id="story-screen" class="screen-overlay">
        <div id="story-title" class="intro-title"></div>
        <div id="story-text" class="intro-text"></div>
        <div class="blink-btn" id="story-btn">–î–ê–õ–ï–ï</div>
    </div>
    
    <div id="victory-screen" class="screen-overlay" style="background:#101; justify-content: flex-start; padding-top:40px;">
        <div style="color:#0f0; font-size:18px; margin-bottom:20px;">–û–†–ì–ê–ù–ò–ó–ú –°–ü–ê–°–ï–ù!</div>
        <div style="font-size:10px; margin-bottom:10px; color:#aaa;">–ì–ê–†–ê–ú –õ–ò–°–¢:</div>
        <div id="harem-list" style="display:flex; gap:10px; margin-bottom:30px;"></div>
        <div id="final-score" style="font-size:10px; color:#fff;"></div>
        <div class="blink-btn" onclick="hardReset()">–ù–û–í–ê–Ø –ò–ì–†–ê</div>
    </div>
    
    <div id="dead-screen" class="screen-overlay" style="background:#400;">
        <div style="font-size:20px; color:#fff; margin-bottom:20px;">–í–´ –ü–û–ì–ò–ë–õ–ò</div>
        <div class="blink-btn" onclick="location.reload()">–ó–ê–ù–û–í–û</div>
    </div>

    <div id="editor-overlay">
        <div class="editor-header">
            <span>REDAKTOR</span>
            <button class="action-btn" onclick="toggleEditor()" style="width:30px; background:#444;">X</button>
        </div>
        <div class="editor-tabs">
            <button class="tab-btn active" onclick="switchTab('chars')">–ü–ï–†–°–û–ù–ê–ñ–ò</button>
            <button class="tab-btn" onclick="switchTab('levels')">–°–Æ–ñ–ï–¢</button>
        </div>
        <div id="editor-body" class="editor-content">
            </div>
        <div class="save-bar">
            <button class="action-btn btn-save" onclick="saveEditorData()">–°–û–•–†–ê–ù–ò–¢–¨</button>
            <button class="action-btn btn-export" onclick="exportData()">JSON</button>
            <button class="action-btn btn-reset" onclick="resetEditorData()">–°–ë–†–û–°</button>
        </div>
    </div>
</div>

<div id="controls-area">
    <div style="font-size:12px; font-weight:bold; color:#888; position:absolute; top:5px; left:20px;">BIO-BOY</div>
    <div style="display:flex; width:100%; justify-content:space-between; padding: 0 30px; box-sizing: border-box;">
        <div class="dpad-container">
            <div class="btn btn-strafe" id="btn-sl">L</div><div></div><div class="btn btn-strafe" id="btn-sr">R</div>
            <div></div><div class="btn" id="btn-up">‚ñ≤</div><div></div>
            <div class="btn" id="btn-left">‚óÑ</div><div style="width:15px; height:15px; background:#222; border-radius:50%;"></div><div class="btn" id="btn-right">‚ñ∫</div>
            <div></div><div class="btn" id="btn-down">‚ñº</div><div></div>
        </div>
        <div class="action-btns">
            <div style="display:flex; flex-direction:column; align-items:center;">
                <div class="round-btn" id="btn-wait">WAIT</div>
                <div style="font-size:8px; color:#888; margin-top:5px;">B</div>
            </div>
            <div style="display:flex; flex-direction:column; align-items:center; margin-top:-15px;">
                <div class="round-btn" id="btn-act">FIRE</div>
                <div style="font-size:8px; color:#888; margin-top:5px;">A</div>
            </div>
        </div>
    </div>
    <div class="brand">Organism Corp.</div>
</div>

<script>
window.onerror = function(msg, url, line) {
    document.getElementById('error-msg').style.display = 'block';
    document.getElementById('error-msg').innerText = "Err: " + msg + " (" + line + ")";
};

// --- DEFAULT DATA (BACKUP) ---
const DEFAULT_LEVELS = [
    {
        name: "–ê–†–¢–ï–†–ò–ò", bg: 0xffeebb, fog: 0xffaaaa, wall: 0xff4444, floor: 0x552222,
        title: "–≠–ü–ò–ó–û–î 1: –ö–†–û–í–¨", text: "–¶–ï–õ–¨: –ù–ê–ô–¢–ò –ö–õ–Æ–ß-–ù–ï–†–í –ò –û–¢–ö–†–´–¢–¨ –®–õ–Æ–ó.\n\n–í–†–ê–ì–ò: –í–ò–†–£–°–´.\n–°–û–ë–ò–†–ê–ô –î–ù–ö –î–õ–Ø –ü–û–ö–£–ü–û–ö.",
        goal: 'find_key', enemyPool: ['virus'], npcPool: ['sexy', 'strict']
    },
    {
        name: "–ñ–ï–õ–£–î–û–ö", bg: 0xddffdd, fog: 0x88cc88, wall: 0x88cc44, floor: 0x446622,
        title: "–≠–ü–ò–ó–û–î 2: –ö–ò–°–õ–û–¢–ê", text: "–¶–ï–õ–¨: –£–ù–ò–ß–¢–û–ñ–ò–¢–¨ –í–°–ï–• –í–†–ê–ì–û–í.\n\n–°–û–í–ï–¢: –ò–°–ü–û–õ–¨–ó–£–ô –°–¢–†–ï–ô–§ (L/R).",
        goal: 'kill_all', enemyPool: ['bacteria'], npcPool: ['shy']
    },
    {
        name: "–ö–ò–®–ï–ß–ù–ò–ö", bg: 0x220033, fog: 0x220033, wall: 0x6600cc, floor: 0x110011,
        title: "–§–ò–ù–ê–õ: –¢–¨–ú–ê", text: "–¶–ï–õ–¨: –£–ù–ò–ß–¢–û–ñ–ò–¢–¨ –ë–û–°–°–ê (–ì–û–ù–û–†–ï–Æ).",
        goal: 'boss', enemyPool: ['virus', 'bacteria', 'parasite'], npcPool: ['sexy', 'strict', 'shy']
    }
];

const DEFAULT_BESTIARY = {
    'virus': { label: '–í–ò–†–£–°', color: '#00cc00', shape: 'circle', hp: 20, atk: [3, 6], drops: [2,5], type:'enemy', symbol:'V' },
    'bacteria': { label: '–°–õ–ò–ó–ï–ù–¨', color: '#aaaa00', shape: 'square', hp: 45, atk: [5, 10], drops: [4,8], type:'enemy', symbol:'B' },
    'parasite': { label: '–ì–õ–ò–°–¢', color: '#ff0000', shape: 'spike', hp: 15, atk: [10, 15], drops: [5,10], type:'enemy', symbol:'S' },
    'boss': { label: '–ì–û–ù–û–†–ï–Ø', color: '#000000', shape: 'skull', hp: 300, atk: [15, 25], drops: [100,100], type:'enemy', symbol:'‚ò†' },
    'sexy': { label: '–ö–†–ê–°–û–¢–ö–ê', color: '#ff55cc', shape: 'heart', type: 'npc', symbol:'‚ô•', perk:'hp', cost:10, lines: ["–ü—Ä–∏–≤–µ—Ç, –ø—É–ø—Å–∏–∫.", "–£—Å–∏–ª–∏—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ?"] },
    'strict': { label: '–¢–ï–•–ù–ò–ö', color: '#5555ff', shape: 'box', type: 'npc', symbol:'!', perk:'ammo', cost:10, lines: ["–ë–æ–µ—Ü! –ù—É–∂–Ω—ã –ø–∞—Ç—Ä–æ–Ω—ã?", "–í–∑—è—Ç—å –±–æ–µ–∫–æ–º–ø–ª–µ–∫—Ç!"] },
    'shy': { label: '–°–¢–ê–ñ–ï–†', color: '#aa88ff', shape: 'star', type: 'npc', symbol:'?', perk:'luck', cost:10, lines: ["–Ø... —è –Ω–∞—à–ª–∞ —ç—Ç–æ...", "–£–¥–∞—á–∞ –Ω–µ –ø–æ–º–µ—à–∞–µ—Ç..."] },
    'key': { label: '–ù–ï–†–í', color: '#ffff00', shape: 'star', type: 'item', symbol:'K' },
    'door': { label: '–í–´–•–û–î', color: '#ffffff', shape: 'door', type: 'door', symbol:'EXIT' }
};

// --- DATA LOADER ---
let LEVELS = JSON.parse(JSON.stringify(DEFAULT_LEVELS));
let BESTIARY = JSON.parse(JSON.stringify(DEFAULT_BESTIARY));

function loadCustomContent() {
    const customLevels = localStorage.getItem('bio_custom_levels');
    const customBestiary = localStorage.getItem('bio_custom_bestiary');
    if(customLevels) LEVELS = JSON.parse(customLevels);
    if(customBestiary) BESTIARY = JSON.parse(customBestiary);
}
loadCustomContent(); // Run immediately

// --- STATE ---
const DEFAULTS = { hp:100, maxHp:100, ammo:15, maxAmmo:20, dna:0, level:0, perks: { hp:0, ammo:0, luck:0 }, romance: { sexy:false, strict:false, shy:false } };
let state = JSON.parse(JSON.stringify(DEFAULTS));

function loadGame() {
    const s = localStorage.getItem('bio_slayer_v1');
    if(s) { state = { ...state, ...JSON.parse(s) }; state.level=0; state.hp=state.maxHp; state.ammo=state.maxAmmo; }
}
function saveGame() { localStorage.setItem('bio_slayer_v1', JSON.stringify({ maxHp:state.maxHp, maxAmmo:state.maxAmmo, dna:state.dna, perks:state.perks, romance:state.romance })); }
function hardReset() { localStorage.removeItem('bio_slayer_v1'); location.reload(); }

// --- THREE.JS ---
const container = document.getElementById('game-container');
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, 4/3, 0.1, 50);
const renderer = new THREE.WebGLRenderer({ antialias: false });
renderer.setSize(container.clientWidth, container.clientHeight);
container.appendChild(renderer.domElement);

// --- ASSETS ---
function createPatternTexture(col, type) {
    const c = document.createElement('canvas'); c.width=64; c.height=64;
    const x = c.getContext('2d');
    x.fillStyle = '#' + col.toString(16).padStart(6,'0'); x.fillRect(0,0,64,64);
    x.fillStyle='rgba(0,0,0,0.1)'; 
    if(type==='wall') { x.fillRect(0,30,64,4); x.fillRect(30,0,4,30); x.fillRect(0,0,4,30); }
    if(type==='floor') { x.fillRect(0,0,32,32); x.fillRect(32,32,32,32); }
    const t = new THREE.CanvasTexture(c); t.magFilter = THREE.NearestFilter; return t;
}

function createIcon(d) {
    const c = document.createElement('canvas'); c.width=128; c.height=128;
    const x = c.getContext('2d');
    x.clearRect(0,0,128,128); 
    x.fillStyle = d.color; x.strokeStyle = '#fff'; x.lineWidth = 6;
    x.beginPath();
    if(d.shape==='door') x.rect(30,10,68,108);
    else if(d.shape==='circle') x.arc(64,64,50,0,Math.PI*2);
    else if(d.shape==='square'||d.shape==='box') x.rect(14,14,100,100);
    else if(d.shape==='heart') { x.arc(40,40,30,0,Math.PI*2); x.arc(88,40,30,0,Math.PI*2); x.moveTo(64,120); }
    else if(d.shape==='spike') { x.moveTo(64,10); x.lineTo(110,110); x.lineTo(18,110); }
    else x.rect(14,14,100,100);
    x.fill(); x.stroke();
    x.fillStyle = '#fff'; x.font = "bold 70px Arial";
    if(d.shape==='door') x.font = "bold 30px Arial";
    x.textAlign = "center"; x.textBaseline = "middle"; x.shadowColor="black"; x.shadowBlur=4;
    x.fillText(d.symbol, 64, 64);
    const t = new THREE.CanvasTexture(c); t.magFilter = THREE.NearestFilter; return t;
}

const wallMat = new THREE.MeshBasicMaterial();
const floorMat = new THREE.MeshBasicMaterial();
const spriteMats = {};
function getMat(key) {
    // Regenerate texture if edited
    spriteMats[key] = new THREE.SpriteMaterial({ map: createIcon(BESTIARY[key]), transparent: true, alphaTest:0.5 });
    return spriteMats[key];
}

const walls = new Map();
const ents = [];
const floorMesh = new THREE.Mesh(new THREE.PlaneGeometry(100,100), floorMat);
floorMesh.rotation.x = -Math.PI/2; scene.add(floorMesh);

// --- LEVEL ---
const runtime = { x:0, z:0, rot:0, visX:0, visZ:0, visRot:0, mode:'MENU', hasKey:false, shake:0 };

function startLevel(idx) {
    state.level = idx;
    const lvl = LEVELS[idx];
    scene.background = new THREE.Color(lvl.bg); scene.fog = new THREE.FogExp2(lvl.fog, 0.08);
    wallMat.map = createPatternTexture(lvl.wall, 'wall');
    floorMat.map = createPatternTexture(lvl.floor, 'floor');
    walls.clear(); ents.forEach(e=>scene.remove(e.mesh)); ents.length=0;
    runtime.hasKey = false;
    
    const sz = 6 + idx; 
    for(let x=-sz; x<=sz; x++) for(let z=-sz; z<=sz; z++) {
        if(Math.abs(x)===sz || Math.abs(z)===sz) { addWall(x,z); continue; }
        if(x===0 && z===0) continue;
        const r = Math.random();
        if(r < 0.15) addWall(x,z);
        else if (r < 0.28) addEnt(x,z,lvl.enemyPool[Math.floor(Math.random()*lvl.enemyPool.length)]);
        else if (r < 0.35) addEnt(x,z,lvl.npcPool[Math.floor(Math.random()*lvl.npcPool.length)]);
    }
    
    if(lvl.goal === 'find_key') { addEnt(sz-2, -sz+2, 'key'); addDoor(0, -sz+1); }
    else if (lvl.goal === 'kill_all') { addDoor(0, -sz+1); }
    else if (lvl.goal === 'boss') { clearSpot(0,-4); addEnt(0, -4, 'boss'); }
    
    runtime.x=0; runtime.z=0; runtime.rot=0; runtime.visX=0; runtime.visZ=0; runtime.visRot=0;
    runtime.mode = 'EXPLORE'; 
    
    document.getElementById('story-screen').style.display='flex';
    document.getElementById('story-title').innerText = lvl.title;
    document.getElementById('story-text').innerText = lvl.text;
    document.getElementById('story-btn').onclick = () => {
        document.getElementById('story-screen').style.display='none';
        log(lvl.name + "."); updateUI();
    };
}

function addWall(x,z) { const m=new THREE.Mesh(new THREE.BoxGeometry(2,2,2), wallMat); m.position.set(x*2,1,z*2); scene.add(m); walls.set(`${x},${z}`, m); }
function clearSpot(x,z) { if(walls.has(`${x},${z}`)) { scene.remove(walls.get(`${x},${z}`)); walls.delete(`${x},${z}`); } ents.forEach(e=>{if(e.x===x&&e.z===z)e.active=false}); }
function addDoor(x,z) { clearSpot(x,z); addEnt(x,z,'door'); }
function addEnt(x,z,key) {
    const s = new THREE.Sprite(getMat(key));
    const scale = key==='boss'?4.0:2.0;
    s.position.set(x*2, key==='door'?1.0:1.3, z*2); s.scale.set(scale,scale,1);
    const d = BESTIARY[key];
    ents.push({ x, z, key, mesh:s, active:true, hp: d.hp||10, type: d.type, label: d.label });
    scene.add(s);
}

// --- LOGIC ---
function getDir(r) { const i=(Math.round(r)+1000)%4; if(i===0)return{x:0,z:-1};if(i===1)return{x:-1,z:0};if(i===2)return{x:0,z:1};return{x:1,z:0}; }

function tryMove(dx, dz) {
    if(runtime.mode!=='EXPLORE') return;
    const tx = runtime.x + dx; const tz = runtime.z + dz;
    if(walls.has(`${tx},${tz}`)) { log("–°–¢–ï–ù–ê."); return; }
    
    const e = ents.find(en => en.x===tx && en.z===tz && en.active);
    if(e) {
        if(e.type==='enemy') { playerAttack(e, 'melee'); return; }
        if(e.type==='npc') { startDialog(e); return; }
        if(e.key==='key') { runtime.hasKey=true; log("–ö–õ–Æ–ß –ü–û–õ–£–ß–ï–ù!"); showFloat("–ö–õ–Æ–ß!", 0, -20, '#ff0'); e.active=false; e.mesh.visible=false; updateUI(); return; }
        if(e.type==='door') { checkDoor(); return; }
        if(e.key==='boss') { startDialog(e); return; }
    }
    runtime.x=tx; runtime.z=tz; sfx('step'); endTurn();
}

function strafe(dir) { const f = getDir(runtime.rot); tryMove(-f.z*dir, f.x*dir); }
function move(dir) { const d = getDir(runtime.rot); tryMove(d.x*dir, d.z*dir); }
function rotate(dir) { if(runtime.mode==='EXPLORE') runtime.rot+=dir; }

function shoot() {
    if(runtime.mode!=='EXPLORE') return;
    const d = getDir(runtime.rot);
    let hit = null;
    for(let i=1; i<5; i++) {
        const tx = runtime.x + d.x*i; const tz = runtime.z + d.z*i;
        if(walls.has(`${tx},${tz}`)) break;
        const e = ents.find(en => en.x===tx && en.z===tz && en.active);
        if(e && e.type==='enemy') { hit = e; break; }
    }
    if(state.ammo>0) {
        state.ammo--; sfx('shoot'); runtime.shake=0.2;
        if(hit) playerAttack(hit, 'ranged'); else log("–ü–†–û–ú–ê–•.");
    } else { log("–ù–ï–¢ –ü–ê–¢–†–û–ù–û–í!"); sfx('empty'); }
    updateUI();
}

function playerAttack(t, type) {
    const isCrit = Math.random() < (0.1 + state.perks.luck*0.1);
    let dmg = type==='melee' ? 5 : 15;
    if(isCrit) { dmg *= 2; showFloat("–ö–†–ò–¢!", 0, 20, '#ff0'); }
    t.hp -= dmg; showFloat("-"+dmg, 0, 0, '#fff');
    t.mesh.position.y += 0.3; setTimeout(()=>t.mesh.position.y-=0.3, 100);
    
    if(t.hp <= 0) {
        t.active = false; t.mesh.visible = false; log(`${t.label} –£–ë–ò–¢.`);
        if(BESTIARY[t.key].drops) {
            const drops = BESTIARY[t.key].drops;
            const drop = Math.floor(Math.random()*(drops[1]-drops[0])) + drops[0];
            state.dna += drop; showFloat(`+${drop} DNA`, 0, -30, '#f0f');
        }
        if(t.key==='boss') setTimeout(showVictory, 1000);
    } else { endTurn(); }
}

function endTurn() {
    ents.forEach(e => {
        if(!e.active || e.type!=='enemy') return;
        const dist = Math.abs(e.x-runtime.x) + Math.abs(e.z-runtime.z);
        if(dist === 1) {
            const dmg = 5; state.hp -= dmg; log(`${e.label} –ö–£–°–ê–ï–¢!`);
            const ol = document.getElementById('damage-overlay');
            if(ol) { ol.style.opacity=0.6; setTimeout(()=>ol.style.opacity=0, 200); }
            if(state.hp<=0) document.getElementById('dead-screen').style.display='flex';
        } else if (dist < 5 && dist > 1) {
            let mx=0, mz=0; if(Math.abs(e.x-runtime.x)>Math.abs(e.z-runtime.z)) mx=(e.x>runtime.x)?-1:1; else mz=(e.z>runtime.z)?-1:1;
            const tx=e.x+mx; const tz=e.z+mz;
            if(!walls.has(`${tx},${tz}`) && !ents.find(en=>en.x===tx && en.z===tz && en.active)) { e.x=tx; e.z=tz; }
        }
    });
    updateUI();
}

function checkDoor() {
    const lvl = LEVELS[state.level];
    let ok = false;
    if(lvl.goal === 'find_key' && runtime.hasKey) ok = true;
    if(lvl.goal === 'kill_all') { if(!ents.some(e=>e.type==='enemy' && e.active)) ok = true; else log("–í–†–ê–ì–ò –ñ–ò–í–´!"); }
    if(ok) { sfx('door'); if(state.level < 2) startLevel(state.level+1); else showVictory(); } else { if(lvl.goal==='find_key')log("–ù–£–ñ–ï–ù –ö–õ–Æ–ß!"); sfx('denied'); }
}

function startDialog(npc) {
    runtime.mode = 'DIALOGUE';
    const ui = document.getElementById('d-opts'); ui.style.display='grid'; ui.innerHTML='';
    const d = BESTIARY[npc.key];
    
    if(npc.key === 'boss') {
        log("–ì–û–ù–û–†–ï–Ø: –£–î–ê–õ–ï–ù–ò–ï...");
        addBtn(ui, "–ë–û–ô", ()=>{ endDlg(); playerAttack(npc, 'melee'); });
    } else {
        const lines = d.lines || ["..."];
        log(`${d.label}: "${lines[Math.floor(Math.random()*lines.length)]}"`);
        const cost = d.cost + (state.perks[d.perk] * 10);
        addBtn(ui, `+${d.perk.toUpperCase()} (${cost} DNA)`, () => {
            if(state.dna >= cost) {
                state.dna -= cost; state.perks[d.perk]++; state.romance[npc.key] = true;
                if(d.perk==='hp') { state.maxHp+=20; state.hp=state.maxHp; log("HP++"); }
                if(d.perk==='ammo') { state.maxAmmo+=10; state.ammo=state.maxAmmo; log("AMMO++"); }
                showFloat("UPGRADE!", 0,0, '#0f0'); saveGame(); npcLeave(npc);
            } else log("–ù–ï–¢ –î–ù–ö.");
        });
        addBtn(ui, "–ü–û–ú–û–©–¨", () => {
            if(npc.key==='sexy') state.hp = Math.min(state.maxHp, state.hp+30);
            if(npc.key==='strict') state.ammo = Math.min(state.maxAmmo, state.ammo+5);
            if(npc.key==='shy') { state.dna += 5; showFloat("+5 DNA",0,0,'#f0f'); }
            updateUI(); npcLeave(npc);
        });
        addBtn(ui, "–£–ô–¢–ò", endDlg);
    }
}
function addBtn(p,t,cb) { const b=document.createElement('div'); b.className='d-btn'; b.innerText=t; b.onclick=cb; p.appendChild(b); }
function npcLeave(n) { n.active=false; n.mesh.visible=false; endDlg(); }
function endDlg() { document.getElementById('d-opts').style.display='none'; runtime.mode='EXPLORE'; updateUI(); }

function log(msg) { document.getElementById('log-text').innerText = `> ${msg}\n` + document.getElementById('log-text').innerText.slice(0, 100); }
function showFloat(txt, x, y, col) {
    const el = document.createElement('div'); el.className='float-msg'; el.innerText=txt;
    el.style.color=col; el.style.left = `calc(50% + ${x}px)`; el.style.top = `calc(50% + ${y}px)`;
    document.getElementById('floating-text-container').appendChild(el);
    setTimeout(()=>el.remove(), 1000);
}
function updateUI() { 
    document.getElementById('ui-hp').innerText=state.hp; document.getElementById('ui-ammo').innerText=state.ammo; document.getElementById('ui-dna').innerText=state.dna;
    document.getElementById('key-icon').style.display = runtime.hasKey ? 'inline' : 'none';
    const d = getDir(runtime.rot); const e = ents.find(en=>en.x===runtime.x+d.x && en.z===runtime.z+d.z && en.active); const b = document.getElementById('btn-act');
    if(e && (e.type==='npc'||e.key==='boss')) { b.innerText="–ì–û–í–û–†"; b.classList.add('talk-mode'); } else { b.innerText="–û–ì–û–ù–¨"; b.classList.remove('talk-mode'); }
}
function showVictory() {
    document.getElementById('victory-screen').style.display='flex';
    let hList = "";
    if(state.romance.sexy) hList += "üíñ "; if(state.romance.strict) hList += "üîß "; if(state.romance.shy) hList += "‚≠ê ";
    document.getElementById('harem-list').innerText = hList || "SOLO";
    document.getElementById('final-score').innerText = `DNA: ${state.dna} | MAX HP: ${state.maxHp}`;
}

// --- EDITOR ---
function toggleEditor() {
    const ed = document.getElementById('editor-overlay');
    if(ed.style.display === 'flex') { ed.style.display='none'; } else { ed.style.display='flex'; switchTab('chars'); }
}
function switchTab(tab) {
    const div = document.getElementById('editor-body'); div.innerHTML = "";
    if(tab === 'chars') {
        for(let k in BESTIARY) {
            const d = BESTIARY[k];
            div.innerHTML += `
            <div class="edit-group">
                <h4>${d.label} (${k})</h4>
                <div class="form-row"><label>–ò–ú–Ø:</label><input onchange="BESTIARY['${k}'].label=this.value" value="${d.label}"></div>
                <div class="form-row"><label>HP:</label><input type="number" onchange="BESTIARY['${k}'].hp=parseInt(this.value)" value="${d.hp||100}"></div>
                <div class="form-row"><label>–°–ò–ú–í–û–õ:</label><input onchange="BESTIARY['${k}'].symbol=this.value" value="${d.symbol}"></div>
                <div class="form-row"><label>–§–†–ê–ó–´:</label><textarea onchange="BESTIARY['${k}'].lines=this.value.split('\\n')">${(d.lines||[]).join('\n')}</textarea></div>
            </div>`;
        }
    } else {
        LEVELS.forEach((l, i) => {
            div.innerHTML += `
            <div class="edit-group">
                <h4>–£–†–û–í–ï–ù–¨ ${i+1}: ${l.name}</h4>
                <div class="form-row"><label>–ó–ê–ì–û–õ–û–í–û–ö:</label><input onchange="LEVELS[${i}].title=this.value" value="${l.title}"></div>
                <div class="form-row"><label>–¢–ï–ö–°–¢:</label><textarea onchange="LEVELS[${i}].text=this.value">${l.text}</textarea></div>
            </div>`;
        });
    }
}
function saveEditorData() {
    localStorage.setItem('bio_custom_levels', JSON.stringify(LEVELS));
    localStorage.setItem('bio_custom_bestiary', JSON.stringify(BESTIARY));
    alert("–°–û–•–†–ê–ù–ï–ù–û! –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏ –∏–≥—Ä—É.");
}
function resetEditorData() {
    localStorage.removeItem('bio_custom_levels'); localStorage.removeItem('bio_custom_bestiary');
    alert("–°–ë–†–û–®–ï–ù–û. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏.");
}
function exportData() {
    const data = { levels: LEVELS, bestiary: BESTIARY };
    navigator.clipboard.writeText(JSON.stringify(data));
    alert("JSON —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!");
}
document.getElementById('dev-btn').onclick = toggleEditor;

// --- RENDER LOOP ---
function animate() {
    requestAnimationFrame(animate);
    runtime.visX += (runtime.x - runtime.visX)*0.2; runtime.visZ += (runtime.z - runtime.visZ)*0.2; runtime.visRot += (runtime.rot - runtime.visRot)*0.2;
    if(runtime.shake>0) runtime.shake*=0.8;
    const sx = (Math.random()-0.5)*runtime.shake; const sy = (Math.random()-0.5)*runtime.shake;
    camera.position.set(runtime.visX*2+sx, 1+sy, runtime.visZ*2);
    camera.rotation.y = runtime.visRot*(Math.PI/2);
    ents.forEach(e=>{ if(e.active) { e.mesh.lookAt(camera.position); e.mesh.position.set(e.x*2, e.key==='door'?1.0:1.3, e.z*2); } });
    
    const mm = document.getElementById('minimap').getContext('2d');
    mm.fillStyle='#fff'; mm.fillRect(0,0,50,50);
    mm.save(); mm.translate(25,25); mm.rotate(-runtime.visRot*(Math.PI/2) + Math.PI); 
    const r=4; const s=6;
    for(let x=runtime.x-r; x<=runtime.x+r; x++) for(let z=runtime.z-r; z<=runtime.z+r; z++) {
        const dx=(x-runtime.x)*s; const dz=(z-runtime.z)*s;
        if(walls.has(`${x},${z}`)) { mm.fillStyle='#000'; mm.fillRect(dx-3,dz-3,6,6); }
        const e=ents.find(en=>en.x===x && en.z===z && en.active);
        if(e) { mm.fillStyle = e.type==='npc'?'#00f':(e.type==='item'?'#ff0':(e.type==='door'?'#fff':'#f00')); mm.fillRect(dx-2,dz-2,4,4); }
    }
    mm.restore(); mm.fillStyle='#0b0'; mm.fillRect(23,23,4,4);
    renderer.render(scene, camera);
}

const ac = new (window.AudioContext||window.webkitAudioContext)();
function sfx(t) {
    if(ac.state==='suspended') ac.resume();
    const o=ac.createOscillator(); const g=ac.createGain(); o.connect(g); g.connect(ac.destination);
    const n=ac.currentTime;
    if(t==='step'){o.frequency.setValueAtTime(60,n);o.frequency.linearRampToValueAtTime(10,n+0.05);g.gain.setValueAtTime(0.1,n);g.gain.linearRampToValueAtTime(0,n+0.05);o.start();o.stop(n+0.05);}
    if(t==='shoot'){o.type='square';o.frequency.setValueAtTime(200,n);o.frequency.linearRampToValueAtTime(50,n+0.1);g.gain.setValueAtTime(0.1,n);g.gain.linearRampToValueAtTime(0,n+0.1);o.start();o.stop(n+0.1);}
    if(t==='pickup'){o.type='triangle';o.frequency.setValueAtTime(400,n);o.frequency.linearRampToValueAtTime(800,n+0.2);g.gain.setValueAtTime(0.1,n);g.gain.linearRampToValueAtTime(0,n+0.2);o.start();o.stop(n+0.2);}
    if(t==='door'){o.type='sawtooth';o.frequency.setValueAtTime(100,n);o.frequency.linearRampToValueAtTime(300,n+0.3);g.gain.setValueAtTime(0.1,n);g.gain.linearRampToValueAtTime(0,n+0.3);o.start();o.stop(n+0.3);}
    if(t==='denied'){o.type='square';o.frequency.setValueAtTime(150,n);g.gain.setValueAtTime(0.1,n);g.gain.linearRampToValueAtTime(0,n+0.1);o.start();o.stop(n+0.1);}
}

document.getElementById('start-btn').onclick = () => { document.getElementById('main-menu').style.display='none'; loadGame(); startLevel(0); animate(); };
const bind = (id,cb) => document.getElementById(id).addEventListener('pointerdown', (e)=>{e.preventDefault(); cb();});
bind('btn-up', ()=>move(1)); bind('btn-down', ()=>move(-1));
bind('btn-left', ()=>rotate(1)); bind('btn-right', ()=>rotate(-1));
bind('btn-sl', ()=>strafe(-1)); bind('btn-sr', ()=>strafe(1));
bind('btn-act', ()=>shoot()); bind('btn-wait', ()=>log("–ñ–î–ï–ú..."), endTurn);
window.addEventListener('resize', ()=>{ const c=document.getElementById('game-container'); camera.aspect=c.clientWidth/c.clientHeight; camera.updateProjectionMatrix(); renderer.setSize(c.clientWidth,c.clientHeight); });

</script>
</body>
</html>


